using System;
using System.CodeDom;
using System.Collections;
using System.Xml.Schema;
using System.CodeDom.Compiler;

namespace Tools.VisualStudioT.GeneratorsT.XsdGenerator.Extensions{
	/// <summary>Creates list of types</summary>
	public class TypeList : ICodeExtension	{
        void ICodeExtension.Initialize(System.Collections.Generic.IDictionary<string, string> Parameters) { }
        public void Process(CodeNamespace code, XmlSchema schema, CodeDomProvider Provider) {
            CodeTypeDeclaration misc = new CodeTypeDeclaration("misc");
            if (Provider.FileExtension == "vb") misc.UserData["Module"] = true;
            else misc.IsPartial = true;
            misc.TypeAttributes = System.Reflection.TypeAttributes.Sealed | System.Reflection.TypeAttributes.NotPublic;
            misc.Comments.Add(new CodeCommentStatement(new CodeComment("<summary>Misc items</summary>", true)));
            CodeMemberField types = new CodeMemberField(
                new CodeTypeReference(new CodeTypeReference(typeof(Type)), 1), "types");
            types.Attributes = MemberAttributes.Assembly | MemberAttributes.Static;
            types.InitExpression = new CodeArrayCreateExpression();
            types.Comments.Add(new CodeCommentStatement(new CodeComment("<summary>Array of all types generated by custom tool</summary>", true)));
            ((CodeArrayCreateExpression)types.InitExpression).CreateType = types.Type;
            AddTypes("",false, code.Types, ((CodeArrayCreateExpression)types.InitExpression).Initializers);
            misc.Members.Add(types);
            code.Types.Add(misc);
		}
        private static void AddTypes(string prepend, bool nested, CodeTypeDeclarationCollection types, CodeExpressionCollection into){
            foreach (CodeTypeDeclaration t in types) {
                into.Add(new CodeTypeOfExpression(
                    ((prepend == null || prepend == "") ? "" : (prepend + (nested ? "+" : "."))) + t.Name));
                CodeTypeDeclarationCollection ctd = new CodeTypeDeclarationCollection();
                foreach (CodeTypeMember m in t.Members) {
                    if (m is CodeTypeDeclaration) ctd.Add((CodeTypeDeclaration)m);
                }
                AddTypes(
                    ((prepend == null || prepend == "") ? "" : (prepend + (nested ? "+" : "."))) + t.Name,
                    true, ctd, into);
            }
        }
	}
}
